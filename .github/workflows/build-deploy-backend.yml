name: Build and Deploy Backend

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  AWS_ACCOUNT_ID: 373486034214
  ECS_CLUSTER: backend-cluster
  ECS_SERVICE: backend
  ECS_TASK_FAMILY: backend-task

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.set-image.outputs.image_uri }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Build JAR
        run: mvn -f backend/pom.xml clean package -DskipTests

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::373486034214:role/github-actions-ecr
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: set-image
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          IMAGE_URI=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}
          echo "Image URI: $IMAGE_URI"
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

          cd backend
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

  deploy-ecs:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::373486034214:role/github-actions-terraform
          aws-region: ${{ env.AWS_REGION }}

      - name: Register new ECS task definition
        id: register-task
        run: |
          IMAGE_URI="${{ needs.build-and-push.outputs.image_uri }}"
          echo "Deploying image: $IMAGE_URI"
          
          if [ -z "$IMAGE_URI" ]; then
            echo "Error: IMAGE_URI is empty"
            exit 1
          fi

          TASK_DEF_JSON=$(aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_FAMILY }} \
            --query 'taskDefinition' \
            --output json)

          echo $TASK_DEF_JSON | jq 'del(.status, .revision, .taskDefinitionArn, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' > taskdef.json

          jq --arg IMAGE "$IMAGE_URI" '.containerDefinitions[0].image = $IMAGE' taskdef.json > taskdef-updated.json

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef-updated.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "new_task_def=$NEW_TASK_DEF_ARN" >> $GITHUB_OUTPUT

      - name: Update ECS service to new task definition
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register-task.outputs.new_task_def }} \
            --force-new-deployment